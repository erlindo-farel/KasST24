<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pembayaran Kas Kelas ST24</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ... (SEMUA KODE CSS ANDA YANG PANJANG ITU SEHARUSNYA ADA DI SINI) ... */
:root {
  --primary-color: #6a6ffb;  /* Biru/ungu yang lebih lembut */
  --secondary-color: #289ea9; /* Teal dari tema asli */
  --bg-color: #f8f9fa;       /* Latar belakang halaman (sedikit abu-abu) */
  --card-bg: #ffffff;      /* Warna kartu (putih) */
  --text-dark: #343a40;      /* Teks utama */
  --text-light: #6c757d;     /* Teks sekunder (abu-abu) */
  --border-color: #e9ecef;   /* Warna border */
  --success-color: #28a745;
  --danger-color: #dc3545;
}
body{font-family:'Poppins',sans-serif;margin:0;padding:0;background:var(--bg-color);color:var(--text-dark);}
header{background:linear-gradient(90deg, var(--primary-color), #289ea9);color:white;padding:1.5rem;text-align:center;border-bottom-left-radius:16px;border-bottom-right-radius:16px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.5);margin-bottom:2rem;}
header h1{margin:0;font-size:1.8rem;font-weight:600;text-shadow:2px 2px 4px rgba(0, 0, 0, 0.2);}
.container{max-width:950px;margin:2rem auto;background:var(--card-bg);border-radius:12px;padding:2rem;box-shadow:0 8px 30px rgba(0, 0, 0, 0.2);opacity:0;transform:translateY(20px);animation:fadeInUp 0.8s 0.1s forwards;}
@keyframes fadeInUp{to{opacity:1;transform:translateY(0);}}
.info{background:#fcfdff;padding:1.2rem;border-left:5px solid var(--secondary-color);border-radius:8px;margin-bottom:2rem;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1.5rem;margin-bottom:2rem;}
.summary-box{background:var(--card-bg);padding:1.25rem;border-radius:12px;border:1px solid var(--border-color);text-align:center;transition:transform 0.3s ease, box-shadow 0.3s ease;}
.summary-box:hover{transform:translateY(-4px);box-shadow:0 6px 15px rgba(0,0,0,0.07);}
.summary-box h4{margin:0 0 0.5rem 0;font-size:0.9rem;color:var(--text-light);font-weight:500;text-transform:uppercase;}
.summary-value{font-size:1.7rem;font-weight:600;color:var(--primary-color);}
.summary-box:first-child .summary-value{color:var(--secondary-color);}
form{display:flex;flex-direction:column;gap:1rem;background:var(--card-bg);padding:1.5rem;border-radius:12px;border:1px solid var(--border-color);margin-top:1.5rem;margin-bottom:1.5rem;}
form:hover{transform:none;}
input[type="text"],select,#searchBar{padding:0.8rem 1rem;border-radius:8px;border:1px solid var(--border-color);font-size:1rem;font-family:'Poppins', sans-serif;transition:all 0.3s ease;background:#fcfdff;box-shadow:none;width:100%;box-sizing:border-box;}
input[type="text"]::placeholder,#searchBar::placeholder{color:#aaa;}
input[type="text"]:focus,select:focus,#searchBar:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(106, 111, 251, 0.15);background:var(--card-bg);}
label{font-weight:500;color:var(--text-dark);margin-bottom:-0.5rem;}
select{cursor:pointer;}
.pay-btn{padding:12px 24px;font-size:16px;background:var(--primary-color);color:white;border:none;border-radius:8px;cursor:pointer;transition:all 0.3s ease;font-weight:600;font-family:'Poppins', sans-serif;display:flex;align-items:center;justify-content:center;gap:8px;text-transform:capitalize;}
.pay-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(106, 111, 251, 0.3);background:#289ea9;}
.pay-btn:active{transform:translateY(0);box-shadow:none;background:#4e54c8;}
.pay-btn.clicked{animation:buttonClicked 0.4s ease forwards;}
@keyframes buttonClicked{0%{transform:scale(1);background:var(--primary-color);} 50%{transform:scale(0.98);background:#4e54c8;box-shadow:0 0 0 0 rgba(106, 111, 251, 0);} 100%{transform:scale(1);background:var(--primary-color);box-shadow:0 4px 12px rgba(106, 111, 251, 0.3);}}
.progress-container{background:var(--border-color);border-radius:20px;overflow:hidden;margin-bottom:1.5rem;}
.progress-bar{height:20px;width:0%;background:linear-gradient(90deg, #34d399, #10b981);text-align:center;color:white;font-weight:600;font-size:0.85rem;line-height:20px;transition:width 1s ease-in-out;}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:1.2rem;border:1px solid var(--border-color);border-radius:12px;overflow:hidden;}
th,td{padding:12px 8px;text-align:left;border-bottom:1px solid var(--border-color);}
th{background:#f8f9fa;font-weight:600;color:var(--text-light);font-size:0.85rem;text-transform:uppercase;letter-spacing:0.5px;border-top:0;}
tbody tr:nth-child(even){background:transparent;}
tbody tr:hover{background:#fafaff;transition:0.2s ease;}
tbody tr:last-child td{border-bottom:0;}
.checked{color:var(--success-color);font-weight:500;}
.not-paid{color:var(--danger-color);font-weight:500;}
/* TAMBAHKAN KODE DI BAWAH INI */
.pending {
  color: #ffa000; /* Warna Oranye / Kuning Tua */
  font-weight: 500;
  font-style: italic;
}
/* HILANGKAN MODAL, KARENA KITA PAKAI LINK LANGSUNG */
.toast{visibility:hidden;min-width:250px;background-color:#333;color:white;text-align:center;border-radius:8px;padding:1rem;position:fixed;z-index:1;left:50%;bottom:30px;transform:translateX(-50%);font-size:16px;opacity:0;transition:opacity 0.5s,bottom 0.5s;}
.toast.show{visibility:visible;opacity:1;bottom:50px;}
.qris-card-wrapper{background:none;border:none;box-shadow:none;padding:0.5rem 0;margin-bottom:2rem;}
.qris-card{max-width:300px;margin:0 auto;background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem;box-shadow:0 6px 20px rgba(0, 0, 0, 0.07);text-align:center;transition:transform 0.3s ease, box-shadow 0.3s ease;}
.qris-card:hover{transform:translateY(-4px);box-shadow:0 8px 25px rgba(0, 0, 0, 0.09);}
.qris-card h4{margin:0 0 0.5rem 0;font-weight:600;color:var(--text-dark);font-size:1.1rem;}
.qris-nominal{font-size:0.95rem;color:var(--primary-color);font-weight:500;margin:0 0 1rem 0;padding-top:0.75rem;border-top:2px dashed var(--border-color);}
.qris-image{width:100%;height:auto;border-radius:16px;border:1px solid #eee;margin-bottom:1rem;}
.qris-footer{font-size:0.85rem;color:var(--text-light);margin:0;}
header, .qris-card-wrapper{opacity:0;animation-fill-mode:forwards;}
header{transform:translateY(-20px);animation:slideDown 0.6s 0.1s forwards;}
.qris-card-wrapper{animation:fadeInUp 0.6s 0.3s forwards;}
.container{animation:fadeInUp 0.7s 0.5s forwards;}
@keyframes slideDown{to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
<h1>Data Pembayaran Kas Kelas ST24</h1>
</header>

<div class="qris-card-wrapper">
  <div class="qris-card">
    <h4>Bayar Kas ST24</h4>
    <img src="qris.jpg" alt="QRIS Bendahara" class="qris-image">
    <p class="qris-nominal">Nominal: <strong>Rp 10.000</strong></p>
    <p class="qris-footer">Atau bayar <strong>Cash</strong> ke Bendahara</p>
  </div>
</div>

<div class="container">
  <div class="summary-grid">
    <div class="summary-box">
      <h4>Total Kas Terkumpul</h4>
      <span id="totalKasValue" class="summary-value">Rp 0</span>
    </div>
    <div class="summary-box">
      <h4>Mahasiswa Belum Bayar</h4>
      <span id="unpaidCount" class="summary-value">0</span>
    </div>
    <div class="summary-box">
      <h4>Waktu Tersisa</h4>
      <span id="countdownTimer" class="summary-value">Memuat...</span>
    </div>
  </div>

  <label for="bulanSelect"><strong>Pilih Bulan:</strong></label>
  <select id="bulanSelect">
    <option value="1">Januari</option>
    <option value="2">Februari</option>
    <option value="3">Maret</option>
    <option value="4">April</option>
    <option value="5">Mei</option>
    <option value="6">Juni</option>
    <option value="7">Juli</option>
    <option value="8">Agustus</option>
    <option value="9">September</option>
    <option value="10">Oktober</option>
    <option value="11">November</option>
    <option value="12">Desember</option>
  </select>

  <form id="paymentForm">
    <input type="text" id="nim" placeholder="Masukkan NIM" required>
    <select id="metode" required>
      <option value="">Pilih metode pembayaran</option>
      <option value="Cash">Cash</option>
      <option value="Transfer">Transfer</option>
    </select>
    <input type="file" id="bukti" style="display:none;" accept="image/*">

    <button type="submit" class="pay-btn">
      <span class="btn-text">sudah bayar</span>
    </button>
  </form>

  <div class="progress-container"><div class="progress-bar" id="progressBar">0%</div></div>

  <input type="text" id="searchBar" placeholder="Cari NIM mahasiswa...">

  <table>
    <thead><tr><th>No</th><th>NIM</th><th>Status</th><th>Metode</th><th>Bukti</th></tr></thead>
    <tbody id="tableBody">
      <tr><td colspan="5" style="text-align:center;">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<div id="toast" class="toast"></div>

<script>
// =========================================================================
// SCRIPT BARU UNTUK GOOGLE SHEETS
// =========================================================================

// !!! PASTE URL WEB APP BARU ANDA DARI BAGIAN 3 DI SINI !!!
const scriptURL = "https://script.google.com/macros/s/AKfycbxLx5KhI0lpPAx_8HaWdYO1iN_Hr9Ao75S7WXtiZvLm2ggotcvCe-vhAwhQkUxTYKU3Zg/exec";

// Daftar NIM tetap sama
const daftarNIM = [
  "D1401251011", "D1401251027", "D1401251042", "D1401251052", "D1401251059", "D1401251075", "D1401251080", "D1401251089", "D1401251127", "D2401251004", "D2401251018", "D2401251028", "D2401251055", "D2401251060", "D2401251073", "D2401251091", "D2401251092", "D2401251122", "D2401251123", "D2401251169", "D2401251171", "D3401251004", "D3401251015", "D3401251026", "D3401251050", "D3401251070", "D3401251074", "D3401251082", "D3401251100", "D3401251114", "E2401251027", "E2401251030", "E2401251036", "E2401251039", "E2401251051", "E2401251057", "E2401251067", "E2401251104", "E2401251110", "E3401251019", "E3401251038", "E3401251041", "E3401251056", "E3401251060", "E3401251076", "E3401251080", "E3401251088", "E3401251093", "E3401251120", "E3401251128", "E3401251155", "E3401251163", "E4401251001", "E4401251013", "E4401251037", "E4401251047", "E4401251057", "E4401251074", "E4401251080", "G0401251018", "G0401251019", "G0401251021", "G0401251048", "G2401251006", "G2401251019", "G2401251025", "G2401251041", "G2401251053", "G2401251075", "G2401251079", "G2401251082", "G2401251084", "G4401251012", "G4401251026", "G4401251042", "G4401251048", "G4401251060", "G4401251078", "G4401251089", "G4401251091", "G4401251127", "G4401251133", "G8401251006", "G8401251007", "G8401251020", "G8401251028", "G8401251042", "G8401251067", "G8401251077", "G8401251081", "G8401251104", "G8401251107", "G8401251124", "L1401251002", "L1401251005", "L1401251022", "L1401251051"
];

// --- VARIABEL ---
const tableBody = document.getElementById("tableBody");
const bulanSelect = document.getElementById("bulanSelect");
const searchBar = document.getElementById("searchBar");
const paymentForm = document.getElementById("paymentForm");
const metodeSelect = document.getElementById("metode");
const buktiInput = document.getElementById("bukti");
const progressBar = document.getElementById("progressBar");
const countdownTimer = document.getElementById("countdownTimer");
const toast = document.getElementById("toast");
const unpaidCountEl = document.getElementById("unpaidCount");
const totalKasEl = document.getElementById("totalKasValue");
const payButton = document.querySelector('.pay-btn'); // Pindahkan tombol ke sini

// Hapus 'localStorage' dan ganti dengan variabel global
let statusBayar = {}; // Data akan diisi oleh fungsi loadDataFromServer()

// --- FUNGSI ---

// (Fungsi showModal dan close modal DIHAPUS, karena kita pakai link)

// GANTI DENGAN BLOK FUNGSI BARU INI:
function renderTable(){
  const bulan = bulanSelect.value;
  tableBody.innerHTML = "";
  const filter = searchBar.value.toLowerCase();
  
  if (Object.keys(statusBayar).length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Memuat data...</td></tr>`;
      return;
  }
  
  daftarNIM.forEach((nim,i)=>{
    const data = statusBayar[nim]?.[bulan];
    
    // --- AWAL LOGIKA BARU UNTUK STATUS ---
    
    let statusText = "❌ Belum";
    let classStatus = "not-paid";

    if (data?.paid === true) {
      // 1. Cek apakah sudah "Lunas"
      statusText = "✅ Lunas";
      classStatus = "checked";
    } else if (data?.statusText === "Menunggu Konfirmasi") {
      // 2. Jika tidak lunas, cek apakah "Menunggu Konfirmasi"
      statusText = "⏳ Menunggu Konfirmasi";
      classStatus = "pending"; // Ini kelas CSS baru
    }
    // 3. Jika tidak keduanya, maka akan tetap "❌ Belum"
    
    const metode = data?.metode || "-";
    // Baris ini tetap sama
    const bukti = data?.bukti ? `<a href="${data.bukti}" target="_blank">Lihat Bukti</a>` : "-";
    
    // --- AKHIR LOGIKA BARU UNTUK STATUS ---
    
    if(!nim.toLowerCase().includes(filter)) return;
    
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${nim}</td><td class="${classStatus}">${statusText}</td><td>${metode}</td><td>${bukti}</td>`;
    tableBody.appendChild(tr);
  });
}


function updateDashboard() {
  const bulan = bulanSelect.value;
  let bayarCount = 0;
  let unpaidCount = 0;
  
  // Cek jika data belum ter-load
  if (Object.keys(statusBayar).length === 0) return;

  daftarNIM.forEach(nim => {
    if (statusBayar[nim]?.[bulan]?.paid) { // Logika ini TETAP SAMA
      bayarCount++;
    } else {
      unpaidCount++;
    }
  });

  // 1. Update Total Kas
  const totalKas = bayarCount * 10000;
  totalKasEl.textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(totalKas);

  // 2. Update Belum Bayar
  unpaidCountEl.textContent = unpaidCount;

  // 3. Update Progress Bar
  const percent = Math.round((bayarCount / daftarNIM.length) * 100);
  progressBar.style.width = percent + "%";
  progressBar.textContent = percent + "%";
}

// Fungsi countdown dan showToast TETAP SAMA
function updateCountdown(){
  const bulan = parseInt(bulanSelect.value);
  const year = new Date().getFullYear();
  const daysInMonth = new Date(year, bulan, 0).getDate();
  const deadline = new Date(year, bulan-1, daysInMonth,23,59,59);
  const now = new Date();
  let diff = deadline-now;
  if(diff<=0){ countdownTimer.textContent="Waktu habis!"; } else {
    const days=Math.floor(diff/(1000*60*60*24)); const hours=Math.floor((diff/(1000*60*60))%24);
    const minutes=Math.floor((diff/(1000*60))%60); const seconds=Math.floor((diff/1000)%60);
    if(days > 0){ countdownTimer.textContent = `${days} hari ${hours} jam`; }
    else { countdownTimer.textContent = `${hours} jam ${minutes} mnt ${seconds} dtk`; }
  }
}
function showToast(msg, error = false){ 
  toast.textContent=msg; 
  toast.style.backgroundColor = error ? "var(--danger-color)" : "#333";
  toast.classList.add("show"); 
  setTimeout(()=>{toast.classList.remove("show");}, 3000);
}

// --- FUNGSI BARU UNTUK KIRIM DATA ---
function kirimDataKeServer(dataObject) {
  // Nonaktifkan tombol saat mengirim
  payButton.disabled = true;
  payButton.querySelector('.btn-text').textContent = 'Mengirim...';

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(dataObject)
  })
  .then(res => res.json())
  .then(response => {
    if (response.result === "success") {
      showToast(`Pembayaran bulan ${dataObject.bulan} tercatat untuk NIM ${dataObject.nim}.`);
      paymentForm.reset();
      buktiInput.style.display = "none";
      
      // Muat ulang data dari server untuk update
      loadDataFromServer(); 
      
      // Animasi tombol
      payButton.classList.add('clicked');
      setTimeout(() => payButton.classList.remove('clicked'), 400);

    } else {
      throw new Error(response.message || "Gagal mengirim data");
    }
  })
  .catch(err => {
    console.error("Error:", err);
    showToast("Error: " + err.message, true);
  })
  .finally(() => {
    // Aktifkan tombol kembali
    payButton.disabled = false;
    payButton.querySelector('.btn-text').textContent = 'sudah bayar';
  });
}

// --- EVENT LISTENERS (MODIFIKASI) ---
metodeSelect.addEventListener("change",()=>{
  if(metodeSelect.value==="Transfer"){ buktiInput.style.display="block"; }
  else{ buktiInput.style.display="none"; buktiInput.value=""; }
});

paymentForm.addEventListener("submit",(e)=>{
  e.preventDefault();
  const nim = document.getElementById("nim").value.trim();
  const metode = metodeSelect.value;
  const file = buktiInput.files[0];
  const bulan = bulanSelect.value;
  
  // Validasi (tetap sama)
  if(!daftarNIM.includes(nim)){showToast("NIM tidak terdaftar!", true); return;}
  if(metode===""){showToast("Pilih metode pembayaran!", true); return;}
  if(metode==="Transfer" && !file){showToast("Harap upload bukti pembayaran!", true); return;}
  
  // HAPUS SEMUA LOGIKA localStorage

  const dataToPost = {
    nim: nim,
    bulan: bulan,
    metode: metode,
    buktiBase64: null
  };

  if(file){
    // Jika ada file, baca sebagai Base64
    const reader = new FileReader();
    reader.onload = function(){
      dataToPost.buktiBase64 = reader.result; // Dapatkan string Base64
      kirimDataKeServer(dataToPost); // Kirim ke server
    };
    reader.onerror = function() {
      showToast("Gagal membaca file.", true);
    }
    reader.readAsDataURL(file);
  } else {
    // Jika tidak ada file (metode Cash)
    kirimDataKeServer(dataToPost); // Langsung kirim ke server
  }
});

// Timer tetap sama
setInterval(()=>{ updateCountdown(); },1000);

// Event listener ini TETAP SAMA
bulanSelect.addEventListener("change",()=>{ 
  renderTable(); 
  updateCountdown(); 
  updateDashboard(); 
});
searchBar.addEventListener("input",()=>{ renderTable(); });

// --- FUNGSI BARU UNTUK MEMUAT DATA DARI SERVER ---
function loadDataFromServer() {
  showToast("Memuat data terbaru...");
  fetch(scriptURL) // Ini adalah request GET
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      
      // Simpan data dari server ke variabel global
      statusBayar = data; 
      
      // Panggil fungsi render setelah data siap
      renderTable(); 
      updateDashboard();
      showToast("Data berhasil dimuat!");
    })
    .catch(err => {
      console.error("Gagal memuat data:", err);
      showToast("Gagal memuat data dari server.", true);
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Gagal memuat data. Cek konsol.</td></tr>`;
    });
}

// --- INISIALISASI ---
// Hapus panggilan render/update lama
// Panggil fungsi countdown (tidak perlu data)
updateCountdown(); 
// Panggil fungsi BARU untuk mengambil data dari server
loadDataFromServer();

</script>
</body>
</html>
